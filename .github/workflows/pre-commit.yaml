name: Pre-commit

on:
  pull_request:
  push:

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        run: pip install uv

      - name: Sync dependencies
        run: uv sync --group dev

      - name: Ruff format
        run: uv run ruff format .

      - name: Ruff lint
        run: uv run ruff check .

      - name: Pyright type check
        run: uv run pyright .

      - name: Bandit security check
        run: uv run bandit -c pyproject.toml -r .

  # file-checks:
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Check for trailing whitespace
  #       run: |
  #         if grep -r --include="*.py" --include="*.ts" --include="*.tsx" --include="*.json" --include="*.yaml" --include="*.yml" ' $' .; then
  #           echo "Trailing whitespace found"
  #           exit 1
  #         fi

  #     - name: Check YAML syntax
  #       run: python -m pip install pyyaml && python -c "import yaml; [yaml.safe_load(open(f)) for f in __import__('glob').glob('**/*.yaml', recursive=True)]"

  #     - name: Check JSON syntax
  #       run: |
  #         for file in $(find . -name "*.json" -type f); do
  #           python -m json.tool "$file" > /dev/null || exit 1
  #         done

  #     - name: Detect private keys
  #       run: |
  #         if grep -r --include="*.py" --include="*.ts" --include="*.tsx" "-----BEGIN.*PRIVATE" .; then
  #           echo "Private key found in source"
  #           exit 1
  #         fi
